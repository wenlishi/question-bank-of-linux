# 题库刷题软件 - 安全加固配置指南

## 概述

本文档详细说明如何配置和使用软件的安全加固功能，防止用户反编译和破解。

## 安全防护层次

### 第一层：代码级防护
- **字符串混淆**：关键字符串加密存储
- **反调试检测**：检测调试器、虚拟机环境
- **代码自校验**：检查关键文件完整性
- **随机延迟**：干扰动态分析

### 第二层：打包级防护
- **字节码加密**：PyInstaller的`--key`参数
- **调试信息剥离**：`--strip`参数
- **依赖隐藏**：`--hidden-import`确保所有模块打包

### 第三层：运行时防护
- **多层验证**：启动时、授权时、运行时多次检查
- **安全日志**：记录可疑行为
- **混淆错误**：不暴露真实错误信息

## 配置步骤

### 1. 安装必要依赖
```bash
# 核心加密模块
pip install pycryptodome>=3.15.0

# 进程检测（反调试）
pip install psutil>=5.9.0

# 打包工具
pip install pyinstaller>=5.13.0

# 代码混淆（可选）
pip install pyarmor
```

### 2. 关键文件哈希值
在打包前，需要计算关键文件的哈希值并更新到代码中：

```bash
cd user_version
python -c "
import hashlib
files = ['core/license_manager.py', 'core/protection.py', 'main.py']
for f in files:
    with open(f, 'rb') as file:
        print(f'{f}: {hashlib.sha256(file.read()).hexdigest()}')
"
```

将输出的哈希值更新到 `protection.py` 中的 `critical_files` 字典。

### 3. 使用安全加固打包脚本
```bash
# 运行安全加固打包
build_secure.bat
```

## 高级配置选项

### 1. 自定义加密密钥
修改 `build_secure.bat` 中的 `--key` 参数：
```bash
--key="YourCustomEncryptionKey123!"
```

**建议**：使用长且复杂的密钥，包含大小写字母、数字和特殊字符。

### 2. 启用UPX压缩（可选）
```bash
# 移除 --noupx 参数，并指定UPX路径
--upx-dir="C:\path\to\upx"
```

**注意**：某些杀毒软件可能将UPX压缩的文件误报为病毒。

### 3. 代码混淆（PyArmor）
```bash
# 安装PyArmor
pip install pyarmor

# 混淆代码
pyarmor gen -O dist/obfuscated --exclude admin --exclude data user_version/

# 然后打包混淆后的代码
cd dist/obfuscated
pyinstaller ... main.py
```

## 防护功能详解

### 1. 反调试检测
- **调试器检测**：检查OllyDbg、IDA、x64dbg等进程
- **父进程检测**：检查是否被Python调试器启动
- **运行时间检测**：调试时运行较慢，会被检测

### 2. 虚拟机检测
- **VMware/VirtualBox目录检测**
- **虚拟机进程检测**
- **注册表项检测**（Windows）

### 3. 文件完整性校验
- **SHA256哈希校验**：检查关键文件是否被修改
- **实时计算**：运行时计算并与预存哈希比较
- **静默处理**：检测到篡改时使用混淆的错误信息

### 4. 字符串混淆
- **多层加密**：XOR + Base64 + 字符替换 + 随机插入
- **动态密钥**：基于硬件信息生成加密密钥
- **运行时解密**：仅在需要时解密字符串

## 测试方法

### 1. 正常功能测试
```bash
# 运行打包后的exe
dist\题库刷题软件.exe
```
- 检查是否能正常启动
- 测试授权流程
- 验证主要功能

### 2. 安全防护测试
```bash
# 1. 在调试器中运行（应被检测）
# 2. 修改license_manager.py后运行（应被检测）
# 3. 在虚拟机中运行（应有警告）
# 4. 尝试修改授权文件（应失效）
```

### 3. 性能测试
- 启动时间：应无明显延迟
- 内存使用：应在合理范围内
- 功能响应：应流畅无卡顿

## 故障排除

### 问题1：打包失败
**可能原因**：
1. 缺少依赖包
2. PyInstaller版本不兼容
3. 代码语法错误

**解决方案**：
```bash
# 更新所有依赖
pip install --upgrade pyinstaller pycryptodome psutil

# 检查Python版本
python --version  # 需要Python 3.7+

# 单独测试打包
cd user_version
pyinstaller --onefile --windowed main.py
```

### 问题2：exe文件过大
**原因**：包含所有Python解释器和依赖

**解决方案**：
1. 使用UPX压缩（但可能被误报）
2. 移除不必要的依赖
3. 使用Python嵌入式版本

### 问题3：杀毒软件误报
**原因**：加密、压缩、反调试等行为可能被误判

**解决方案**：
1. 向杀毒软件厂商提交样本
2. 使用数字签名
3. 禁用某些防护功能

### 问题4：防护被绕过
**可能原因**：
1. 字符串加密被破解
2. 反调试被绕过
3. 文件校验被修改

**解决方案**：
1. 定期更新加密算法
2. 增加防护层次
3. 考虑服务器端验证

## 最佳实践

### 1. 定期更新
- 每月更新加密密钥
- 每季度更新防护算法
- 每年重构部分代码

### 2. 分层防护
- 不要依赖单一防护措施
- 实现深度防御
- 关键功能多重验证

### 3. 监控和响应
- 记录安全事件日志
- 分析破解尝试
- 及时更新防护措施

### 4. 用户友好
- 合法用户不应感到不便
- 错误信息友好但安全
- 提供技术支持渠道

## 法律声明

### 1. 使用限制
- 本防护系统仅用于保护合法软件
- 不得用于非法目的
- 遵守当地法律法规

### 2. 免责声明
- 不保证100%防破解
- 使用者自行承担风险
- 定期更新以应对新威胁

### 3. 技术支持
- 问题反馈：security@tikusoft.com
- 更新通知：关注官方网站
- 紧急响应：24小时内处理安全漏洞

## 更新日志

### v1.0 (2024-01-04)
- 基础防护框架
- 反调试和虚拟机检测
- 文件完整性校验
- 字符串混淆

### 计划功能
- 服务器端授权验证
- 硬件指纹绑定
- 行为分析防护
- 云端黑名单

---

**重要提示**：安全是一个持续的过程，需要定期更新和维护。建议至少每季度审查一次安全配置。